# v0.2.3 Python Detection Fix

**Date**: 2025-10-24
**Issue**: Python command not found on P3285-LVR (ARTPEC-9)
**Fix**: Robust Python path detection with fallbacks

---

## Problem

v0.2.2 installed successfully on P3285-LVR but failed to start with repeated errors:

```
[ INFO ] omnisight[7801]: /usr/local/packages/omnisight/omnisight: exec: line 14: python3: not found
[ NOTICE ] systemd[1]: sdkomnisight.service: Main process exited, code=exited, status=127/n/a
```

**Timeline of v0.2.2 Failure:**
- 17:01:10.808 - Upload SUCCESS (9540 bytes)
- 17:01:26.155 - Installation SUCCESS
- 17:01:47.590 - Application started
- 17:01:47.622 - **ERROR: python3: not found**
- 17:01:47.627 - Process exited with status 127
- 17:01:48.838 - **Start request repeated too quickly (5 failed attempts)**
- 17:01:48.879 - **Failed to start OMNISIGHT**

**User Experience:**
- Dashboard loaded successfully showing "Status: Active"
- API test buttons returned "Service Unavailable" errors
- No Python server was running (port 8080 closed)

---

## Root Cause

The P3285-LVR camera (ARTPEC-9) does not have the `python3` command available, while the M4228-LVE camera (ARTPEC-8) does. The launcher script hardcoded `exec python3 hybrid_server.py`, causing immediate failure on ARTPEC-9.

### Camera Comparison:

| Camera | ARTPEC | Python Available | v0.2.2 Result |
|--------|--------|------------------|---------------|
| M4228-LVE | ARTPEC-8 | ✓ `python3` works | Unknown (not tested) |
| P3285-LVR | ARTPEC-9 | ✗ `python3` not found | Failed |

---

## Solution (v0.2.3)

Created a robust launcher script that:

1. **Tries Multiple Python Paths** (in order):
   - `/usr/bin/python3`
   - `/usr/bin/python`
   - `python3` (PATH-based)
   - `python` (PATH-based)

2. **Uses `command -v` for Detection**:
   ```sh
   for py_path in $PYTHON_PATHS; do
       if command -v "$py_path" >/dev/null 2>&1; then
           PYTHON="$py_path"
           echo "Found Python: $PYTHON" >&2
           break
       fi
   done
   ```

3. **Provides Fallback Checks**:
   ```sh
   if [ -z "$PYTHON" ]; then
       if [ -x "/usr/bin/python3" ]; then
           PYTHON="/usr/bin/python3"
       elif [ -x "/usr/bin/python" ]; then
           PYTHON="/usr/bin/python"
       fi
   fi
   ```

4. **Logs Diagnostic Information**:
   - Prints detected Python path to stderr
   - Displays Python version before starting
   - Shows clear error if no Python found

5. **Exits Gracefully on Failure**:
   ```sh
   if [ -z "$PYTHON" ]; then
       echo "ERROR: No Python interpreter found!" >&2
       echo "Checked paths:" >&2
       echo "$PYTHON_PATHS" >&2
       exit 127
   fi
   ```

---

## Testing Expected Behavior

### On P3285-LVR (ARTPEC-9):
The launcher will:
1. Try `/usr/bin/python3` → Not found
2. Try `/usr/bin/python` → Found! ✓
3. Log: `Found Python: /usr/bin/python`
4. Log: `Starting OMNISIGHT with: Python X.X.X`
5. Start hybrid server successfully

### On M4228-LVE (ARTPEC-8):
The launcher will:
1. Try `/usr/bin/python3` → Found! ✓
2. Log: `Found Python: /usr/bin/python3`
3. Log: `Starting OMNISIGHT with: Python 3.X.X`
4. Start hybrid server successfully

### If No Python Available:
The launcher will:
1. Try all paths → None found
2. Log: `ERROR: No Python interpreter found!`
3. List all checked paths
4. Exit with code 127

---

## Files Modified

### [scripts/build-hybrid-eap.sh](../scripts/build-hybrid-eap.sh)
**Changes:**
- Version: `0.2.2` → `0.2.3`
- Launcher script: Complete rewrite with Python detection (lines 54-116)
- Added diagnostic logging to stderr
- Added fallback logic

### [scripts/manifest-hybrid.json](../scripts/manifest-hybrid.json)
**Changes:**
- Version: `"0.2.2"` → `"0.2.3"`

### [scripts/package-hybrid.conf](../scripts/package-hybrid.conf)
**Changes:**
- `APPMICROVERSION="2"` → `APPMICROVERSION="3"`

---

## Package Details

**File**: `OMNISIGHT_-_Precognitive_Security_0_2_3_aarch64.eap`
**Size**: 9 KB
**Contents**:
```
LICENSE          32 bytes
api/             14 JSON files
html/            Dashboard + CSS
hybrid_server.py 6.0 KB
manifest.json    537 bytes
omnisight        1.5 KB (launcher with detection logic)
package.conf     560 bytes
```

**Key Changes from v0.2.2**:
- Launcher script: 69 lines → 115 lines (66% increase)
- Added Python path detection loop
- Added diagnostic logging
- Added graceful error handling

---

## Deployment Instructions

1. **Uninstall v0.2.2** (if installed):
   ```
   Camera Web UI → Settings → Apps → OMNISIGHT → Remove
   ```

2. **Deploy v0.2.3**:
   ```bash
   # Via Web UI:
   Camera → Settings → Apps → Upload → Select .eap file

   # Or via CLI:
   curl -u root:password -F 'package=@OMNISIGHT_-_Precognitive_Security_0_2_3_aarch64.eap' \
     https://camera-ip/axis-cgi/applications/upload.cgi
   ```

3. **Start Application**:
   ```
   Camera Web UI → Apps → OMNISIGHT → Start
   ```

4. **Check Logs** (via SSH):
   ```bash
   # View launcher output
   journalctl -u sdkomnisight.service -n 50

   # Should see:
   # "Found Python: /usr/bin/python"
   # "Starting OMNISIGHT with: Python X.X.X"
   ```

5. **Test API Endpoints**:
   ```
   Open: https://camera-ip/local/omnisight/
   Click: "Test Health Endpoint" → Should return {"status": "healthy"}
   Click: "Test Stats Endpoint" → Should return stats data
   ```

---

## Success Criteria

**Installation:**
- ✓ Package uploads without errors
- ✓ Installation completes successfully
- ✓ No "package.conf" errors (fixed in v0.2.2)

**Runtime:**
- ✓ Application starts successfully
- ✓ No "python3: not found" errors
- ✓ Python path detected and logged
- ✓ Hybrid server runs on port 8080

**Functionality:**
- ✓ Dashboard displays with correct version (0.2.3)
- ✓ API endpoints return valid JSON
- ✓ "Test Health Endpoint" button works
- ✓ "Test Stats Endpoint" button works
- ✓ No "Service Unavailable" errors

---

## Lessons Learned

1. **Python availability varies by ARTPEC version** - Cannot assume `python3` exists
2. **Diagnostic logging is critical** - stderr output helps debug camera deployment issues
3. **Fallback paths are essential** - Different cameras have different Python installations
4. **Test on multiple hardware platforms** - ARTPEC-8 vs ARTPEC-9 have different capabilities

---

## Next Steps (Phase 2.1)

Once v0.2.3 is validated on both cameras:

1. **VDO API Integration** - Real video capture from camera
2. **Larod API Integration** - DLPU hardware acceleration
3. **IPC Implementation** - C modules ↔ Python server communication
4. **Dynamic Data** - Replace stub JSON with real-time data

---

## References

- Error logs: `/Users/matthewvisher/dev logs ACAP/Axis_SR_20251024_170850_E82725203C16/`
- v0.2.2 failure analysis: [V0.2.1_FAILURE_ANALYSIS.md](V0.2.1_FAILURE_ANALYSIS.md)
- Build script: [build-hybrid-eap.sh](../scripts/build-hybrid-eap.sh)
- Launcher code: Lines 54-116 in build script
