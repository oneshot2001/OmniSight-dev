# v0.2.4 Simplified Launcher Fix

**Date**: 2025-10-27
**Issue**: v0.2.3 failed with exit-code - `command -v` not available in minimal shell
**Fix**: Simplified launcher using direct Python execution

---

## Problem

v0.2.3 was deployed to P3285-LVR and ran for several hours, but the service repeatedly failed with exit-code errors:

```
2025-10-27T13:29:55.838 [ WARNING ] systemd[1]: sdkomnisight.service: Failed with result 'exit-code'.
2025-10-27T13:29:56.921 [ WARNING ] systemd[1]: sdkomnisight.service: Start request repeated too quickly.
2025-10-27T13:29:56.952 [ ERR     ] systemd[1]: Failed to start OMNISIGHT - Precognitive Security.
```

**Timeline of v0.2.3 Failures:**
- 13:29:55 - Failed with exit-code
- 13:29:56 - Failed with exit-code
- 13:29:56 - "Start request repeated too quickly"
- 13:31:04 - Failed with exit-code (repeated 5+ times)
- 13:31:06 - Gave up starting
- 13:32:09 - More failures logged

Pattern continued for hours - systemd kept trying to restart but immediately failed.

---

## Root Cause Analysis

The v0.2.3 launcher used `command -v` for Python detection:

```sh
for py_path in $PYTHON_PATHS; do
    if command -v "$py_path" >/dev/null 2>&1; then  # ← PROBLEM
        PYTHON="$py_path"
        break
    fi
done
```

**Why this failed:**
1. **`command -v` is a bash built-in** - not available in all `/bin/sh` implementations
2. **ARTPEC-9 uses minimal BusyBox sh** - doesn't include bash built-ins
3. **Script failed immediately** on the first `command -v` call
4. **No diagnostic output** was captured (stderr not logged by systemd in these reports)
5. **Exit code behavior** suggests the command itself errored, not that Python wasn't found

### Evidence from Logs:

**What we saw:**
- ❌ Repeated "Failed with result 'exit-code'" messages
- ❌ No launcher output (no "Found Python:" or "ERROR:" messages)
- ❌ Immediate failures (no delay suggesting Python execution attempts)
- ❌ Exit code 127 not mentioned (which would indicate "command not found")

**What this indicates:**
- The launcher script itself crashed
- Likely on the `command -v` line
- Before any Python detection could succeed

---

## Solution (v0.2.4)

### Simplified Launcher Strategy:

**Before (v0.2.3):**
```sh
# Complex detection with command -v
for py_path in $PYTHON_PATHS; do
    if command -v "$py_path" >/dev/null 2>&1; then
        PYTHON="$py_path"
        break
    fi
done
```

**After (v0.2.4):**
```sh
# Direct execution attempts with if statements
if /usr/bin/python3 --version >/dev/null 2>&1; then
    exec /usr/bin/python3 hybrid_server.py
fi

if /usr/bin/python --version >/dev/null 2>&1; then
    exec /usr/bin/python hybrid_server.py
fi

if which python3 >/dev/null 2>&1; then
    exec python3 hybrid_server.py
fi

if which python >/dev/null 2>&1; then
    exec python hybrid_server.py
fi
```

### Key Improvements:

1. **No bash built-ins** - uses only POSIX-compliant sh features
2. **Direct path execution** - tries `/usr/bin/python3` and `/usr/bin/python` directly
3. **Fallback to `which`** - uses `which` command (available in BusyBox) for PATH search
4. **Immediate exec** - no variable assignment, directly exec on success
5. **Clear error messages** - explicit failure if all attempts exhausted

### Compatibility:

| Shell Feature | v0.2.3 | v0.2.4 | BusyBox sh |
|---------------|--------|--------|------------|
| `command -v` | ✓ Used | ✗ Removed | ✗ Not available |
| `if` statements | ✓ | ✓ | ✓ Available |
| Direct execution | Partial | ✓ Primary | ✓ Works |
| `which` command | Fallback | Fallback | ✓ Available |
| `exec` | ✓ | ✓ | ✓ Available |

---

## Testing Expected Behavior

### On P3285-LVR (ARTPEC-9):

**Startup sequence:**
1. Try `/usr/bin/python3 --version` → Fails (not found)
2. Try `/usr/bin/python --version` → **Succeeds!** ✓
3. Log: "Using /usr/bin/python"
4. Execute: `exec /usr/bin/python hybrid_server.py`
5. Server starts on port 8080

**Success indicators:**
```
[ INFO ] systemd[1]: Started OMNISIGHT - Precognitive Security
omnisight: OMNISIGHT starting...
omnisight: Using /usr/bin/python
```

### On M4228-LVE (ARTPEC-8):

**Startup sequence:**
1. Try `/usr/bin/python3 --version` → **Succeeds!** ✓
2. Log: "Using /usr/bin/python3"
3. Execute: `exec /usr/bin/python3 hybrid_server.py`
4. Server starts on port 8080

### If Python Not Available:

**Startup sequence:**
1. Try `/usr/bin/python3` → Fails
2. Try `/usr/bin/python` → Fails
3. Try `which python3` → Fails
4. Try `which python` → Fails
5. Log: "ERROR: No Python interpreter found!"
6. Log: "Tried: /usr/bin/python3, /usr/bin/python, python3, python"
7. Exit code 127

---

## Files Modified

### [scripts/build-hybrid-eap.sh](../scripts/build-hybrid-eap.sh)

**Version:** 0.2.3 → 0.2.4

**Launcher changes (lines 54-103):**
- Removed `command -v` detection loop
- Added direct Python path execution with `--version` checks
- Simplified from 62 lines → 50 lines (19% reduction)
- Added startup message: "OMNISIGHT starting..."
- Clearer error messages for troubleshooting

**Key code blocks:**
```sh
# Direct execution (new approach)
if /usr/bin/python3 --version >/dev/null 2>&1; then
    echo "Using /usr/bin/python3" >&2
    exec /usr/bin/python3 hybrid_server.py
fi
```

### [scripts/manifest-hybrid.json](../scripts/manifest-hybrid.json)
- Version: `"0.2.3"` → `"0.2.4"`

### [scripts/package-hybrid.conf](../scripts/package-hybrid.conf)
- `APPMICROVERSION="3"` → `APPMICROVERSION="4"`

---

## Package Details

**File**: `OMNISIGHT_-_Precognitive_Security_0_2_4_aarch64.eap`
**Size**: 9 KB (slightly smaller than v0.2.3)

**Contents:**
```
LICENSE           32 bytes
api/              14 JSON files
html/             Dashboard
hybrid_server.py  6.0 KB
manifest.json     537 bytes
omnisight         1.3 KB (simplified launcher)
package.conf      560 bytes
```

**Changes from v0.2.3:**
- Launcher: 1.5 KB → 1.3 KB (200 bytes smaller)
- Approach: bash built-ins → POSIX sh compatible
- Compatibility: ARTPEC-8/9 both supported

---

## Deployment Instructions

### 1. Remove v0.2.3 (Critical!)

**Via Web UI:**
```
Camera → Settings → Apps → OMNISIGHT → Remove
Wait 10 seconds for cleanup
```

**Via SSH:**
```bash
systemctl stop sdkomnisight.service
acapdctl remove omnisight
# Wait for removal to complete
```

### 2. Deploy v0.2.4

**Via Web UI:**
```
Camera → Settings → Apps → Upload
Select: OMNISIGHT_-_Precognitive_Security_0_2_4_aarch64.eap
Click: Upload
```

**Via CLI:**
```bash
curl -u root:password \
  -F 'package=@OMNISIGHT_-_Precognitive_Security_0_2_4_aarch64.eap' \
  https://camera-ip/axis-cgi/applications/upload.cgi
```

### 3. Start and Monitor

**Start application:**
```
Camera Web UI → Apps → OMNISIGHT → Start
```

**Monitor startup (via SSH):**
```bash
# Watch for startup messages
journalctl -u sdkomnisight.service -f

# Should see:
# "OMNISIGHT starting..."
# "Using /usr/bin/python"
# (No errors!)
```

### 4. Verify API Endpoints

**Open dashboard:**
```
https://camera-ip/local/omnisight/
```

**Test buttons:**
- Click "Test Health Endpoint" → Should return `{"status": "healthy"}`
- Click "Test Stats Endpoint" → Should return stats JSON
- ✓ No "Service Unavailable" errors!

**Check port (via SSH):**
```bash
lsof -i :8080
# Should show: python hybrid_server.py
```

---

## Success Criteria

### Installation:
- ✓ Package uploads without errors
- ✓ Installation completes
- ✓ No package.conf errors

### Runtime:
- ✓ Service starts successfully
- ✓ No "exit-code" failures
- ✓ Logs show "Using /usr/bin/python" or "Using /usr/bin/python3"
- ✓ Hybrid server runs on port 8080
- ✓ Service stays running (no crashes)

### Functionality:
- ✓ Dashboard displays with version 0.2.4
- ✓ API endpoints return valid JSON
- ✓ Test buttons work
- ✓ No "Service Unavailable" errors
- ✓ Server responds to requests

---

## Troubleshooting

### If service still fails:

**1. Check logs:**
```bash
journalctl -u sdkomnisight.service -n 100
```

**Look for:**
- "OMNISIGHT starting..." - launcher executed
- "Using /usr/bin/python" - Python found
- "ERROR: No Python interpreter found!" - Python not available
- Python errors - hybrid_server.py issues

**2. Test Python manually (via SSH):**
```bash
cd /usr/local/packages/omnisight
/usr/bin/python --version
/usr/bin/python hybrid_server.py &
```

**3. Check file permissions:**
```bash
ls -la /usr/local/packages/omnisight/omnisight
# Should be: -rwxr-xr-x (executable)
```

**4. Verify package contents:**
```bash
ls -la /usr/local/packages/omnisight/
# Should have: omnisight, hybrid_server.py, html/, api/
```

---

## Lessons Learned

1. **`command -v` is NOT portable** - don't assume bash built-ins work in `/bin/sh`
2. **BusyBox sh is minimal** - use only POSIX-compliant features
3. **Direct execution is safer** - try running commands directly vs. checking existence
4. **Diagnostic logging critical** - ensure startup messages reach systemd journal
5. **Test on target hardware** - macOS/Linux behavior differs from embedded systems

---

## Next Steps (Phase 2.1)

Once v0.2.4 is validated on P3285-LVR:

1. **Test on M4228-LVE** - verify ARTPEC-8 compatibility
2. **Monitor long-term stability** - ensure no crashes over 24+ hours
3. **Proceed to VDO API integration** - real video capture
4. **Implement Larod API** - DLPU hardware acceleration
5. **Add IPC layer** - C modules ↔ Python communication

---

## Version Progression

| Version | Issue | Fix | Result |
|---------|-------|-----|--------|
| v0.2.0 | Exec format error (Flask) | Hybrid Python approach | Failed on install |
| v0.2.1 | Missing package.conf | Added package.conf | Installed but crashed |
| v0.2.2 | python3: not found | Python detection (command -v) | Installed but crashed |
| v0.2.3 | command -v not available | Simpler detection needed | Installed but crashed |
| **v0.2.4** | **Bash built-ins in sh** | **Direct Python execution** | **Should work!** |

---

## References

- v0.2.3 failure logs: `/Users/matthewvisher/dev logs ACAP/Axis_SR_20251027_162440_E82725203C16/`
- Previous fixes: [V0.2.3_PYTHON_DETECTION_FIX.md](V0.2.3_PYTHON_DETECTION_FIX.md)
- Build script: [build-hybrid-eap.sh](../scripts/build-hybrid-eap.sh)
- BusyBox sh documentation: https://www.busybox.net/
